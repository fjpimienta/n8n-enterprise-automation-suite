services:
  n8n:
    build:
      context: .
      dockerfile: Dockerfile.n8n
    container_name: n8n-compose
    restart: always
    ports:
      - "127.0.0.1:5678:5678"
    env_file:
      - .env
    environment:
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_HOST=${SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_RUNNERS_ENABLED=false
      - NODE_ENV=production
      - WEBHOOK_URL=http://${SUBDOMAIN}.${DOMAIN_NAME}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - TZ=${GENERIC_TIMEZONE}
      - N8N_LOG_LEVEL=debug
      - N8N_EXPRESS_TRUST_PROXY=1
      - N8N_EDITOR_BASE_URL=http://${SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_FORCE_HTTPS=false
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres-compose
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n_db
      - DB_POSTGRESDB_USER=n8n_user
      - DB_POSTGRESDB_PASSWORD=n8n_pass
      - NODE_FUNCTION_ALLOW_EXTERNAL=jsonwebtoken,pdf-parse
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - JWT_SECRET=${JWT_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # - N8N_WORKER_COUNT=2
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - SERVICES_TIMEOUT=300   # 60
      - NODE_OPTIONS=--max-old-space-size=4096 --require /home/node/.n8n/custom/init-blob.js  # Aumenta heap a 4GB + path correcto
    depends_on:
      - postgres
    volumes:
      - n8n_restored_data:/home/node/.n8n
      - ./local-files:/files
      - /var/lib/psa/dumps:/var/lib/psa/dumps
      - ./.env:/home/node/.env
      - ./custom:/home/node/.n8n/custom
    networks:
      - n8n-compose_network
    deploy:
      resources:
        limits:
          memory: 4096m

  postgres:
    image: ankane/pgvector:latest
    container_name: postgres-compose
    restart: always
    environment:
      - POSTGRES_DB=n8n_db
      - POSTGRES_USER=n8n_user
      - POSTGRES_PASSWORD=n8n_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/initdb:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - n8n-compose_network

  jwt-service:
    build:
      context: ./jwt-service
      dockerfile: Dockerfile
    container_name: jwt-service
    restart: always
    ports:
      - "4000:4000"
    env_file:
      - .env
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - N8N_CORS_ALLOW_HEADERS=Authorization,Content-Type
      - N8N_CORS_ORIGINS=https://hosting3m.com
    networks:
      - n8n-compose_network

volumes:
  n8n_restored_data:
    external: true
  postgres_data:
    external: false

networks:
  n8n-compose_network:
    driver: bridge

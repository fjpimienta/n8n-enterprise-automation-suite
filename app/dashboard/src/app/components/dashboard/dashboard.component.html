<div class="page-header d-print-none text-white bg-dark py-3">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle text-muted-light">Dashboard</div>
        <h2 class="page-title text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-building-skyscraper" width="24"
            height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M3 21l18 0" />
            <path d="M5 21v-14l8 -4l8 4v14" />
            <path d="M19 21v-10l-6 -4" />
            <path d="M9 9l0 .01" />
            <path d="M9 12l0 .01" />
            <path d="M9 15l0 .01" />
            <path d="M9 18l0 .01" />
          </svg>
          Hotel San Jos&eacute;
        </h2>
      </div>
      <div class="col-auto ms-auto d-flex gap-2">
        <button class="btn btn-icon btn-dark" (click)="refresh()" title="Refrescar">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
          </svg>
        </button>

        <button (click)="generateDailyReport()" class="btn btn-primary btn-sm me-2">
          üí∞ Caja
        </button>

        <button (click)="logout()" class="btn btn-danger btn-sm">Salir</button>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">

    @if (viewMode() === 'details' || viewMode() === 'checkin' || viewMode() === 'checkout_validation') {
    <div class="mb-4">
      <div class="d-flex flex-wrap gap-2 justify-content-center mb-2 px-2">
        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-primary]="hotelService.filter() === 'all'"
          (click)="hotelService.filter.set('all')">Todas</button>
        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-success]="hotelService.filter() === 'available'"
          (click)="hotelService.filter.set('available')">‚úÖ Disponibles</button>
        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-danger]="hotelService.filter() === 'occupied'"
          (click)="hotelService.filter.set('occupied')">üè® Ocupadas</button>
        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-warning]="hotelService.filter() === 'checkout'"
          (click)="hotelService.filter.set('checkout')">üßπ Check-out</button>
        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-secondary]="hotelService.filter() === 'maintenance'"
          (click)="hotelService.filter.set('maintenance')">üõ†Ô∏è Mantenimiento</button>
      </div>

      @if (isAdmin) {
      <div class="d-flex justify-content-center px-2">
        <button (click)="openUserManagement()" class="btn btn-sm btn-outline-info shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users me-1" width="24" height="24"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
            <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
          </svg>
          Gestionar Personal
        </button>
      </div>
      }
    </div>

    <div class="row row-cards g-2">
      @for (room of hotelService.filteredRooms(); track room.id) {
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card card-sm shadow-sm border-0 h-100"
          [style.border-left]="isArrivalToday(room.next_reservation) ? '5px solid #206bc4' : 'none'"
          style="cursor: pointer;" (click)="onSelectRoom(room)">
          <div class="card-body p-3 bg-white rounded">
            <div class="d-flex align-items-center">
              <div class="h1 mb-0 me-3 fw-bold text-primary">{{ room.room_number }}</div>
              <div class="flex-fill text-dark">
                <div class="font-weight-medium h4 mb-0 text-capitalize">{{ room.type }}</div>
                <div class="text-muted small mt-1">
                  @if (room.next_reservation) {
                  <span class="text-azure fw-bold">üìÖ {{ room.next_reservation | date:'dd/MM' }}</span>
                  }
                </div>
              </div>
              <div class="text-end">
                <span class="badge" [class.bg-red-lt]="room.status === 'occupied'"
                  [class.bg-green-lt]="room.status === 'available'" [class.bg-dark-lt]="room.status === 'maintenance'">
                  {{ room.status | uppercase }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
    }

    @if (viewMode() === 'checkin') {
    <div class="modal-backdrop fade show"></div>
    <div class="modal modal-blur fade show d-block" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
          <app-checkin-form [room]="hotelService.selectedRoom()" (onClose)="viewMode.set('details')"
            (saved)="handleCheckinSave($event)"> </app-checkin-form>
        </div>
      </div>
    </div>
    }

    @if (viewMode() === 'user_mgmt') {
    <div class="d-flex mb-3 align-items-center">
      <button (click)="viewMode.set('details')" class="btn btn-sm btn-ghost-secondary me-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-back-up" width="24"
          height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
          <path d="M9 14l-4 -4l4 -4" />
          <path d="M5 10h11a4 4 0 1 1 0 8h-1" />
        </svg>
        Volver
      </button>
      <h2 class="text-white mb-0">Gesti√≥n de Personal</h2>
      <button class="btn btn-primary btn-sm ms-auto" (click)="openNewUserModal()">+ Nuevo Empleado</button>
    </div>

    <div class="row row-cards">
      @for (user of hotelService.users(); track user.email) {
      <div class="col-12 col-md-6">
        <div class="card shadow-sm border-0 mb-2">
          <div class="card-body d-flex align-items-center p-3 text-dark bg-white rounded shadow-sm">
            <span class="avatar avatar-sm me-3 bg-blue-lt text-uppercase fw-bold">
              {{ (user.names || '?').charAt(0) }}{{ (user.lastname || '').charAt(0) }}
            </span>
            <div class="flex-fill">
              <div class="fw-bold">{{ user.names }} {{ user.lastname }}</div>
              <div class="text-muted small">{{ user.role }} ‚Ä¢ {{ user.email }}</div>
            </div>
            <button class="btn btn-icon btn-ghost-primary" (click)="editUser(user)">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
                <path d="M13.5 6.5l4 4" />
              </svg>
            </button>
          </div>
        </div>
      </div>
      }
    </div>
    }

  </div>
</div>

@if (hotelService.selectedRoom() && viewMode() !== 'checkin') {
<div class="modal-backdrop fade show"></div>
<div class="modal modal-blur fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header">
        <h5 class="modal-title">Habitaci√≥n {{ hotelService.selectedRoom()?.room_number }}</h5>
        <button type="button" class="btn-close" (click)="hotelService.clearSelection()"></button>
      </div>
      <div class="modal-body p-4 text-dark bg-white">

        <div class="row mb-3">
          <div class="col">
            <label class="form-label text-muted small">ESTADO DE OCUPACI√ìN</label>
            @if (hotelService.selectedRoom()?.status === 'occupied') {
            <span class="badge bg-red-lt h3">‚óè Ocupada</span>
            } @else {
            <span class="badge bg-green-lt h3">‚óè Disponible</span>
            }
          </div>
          <div class="col-auto text-end">
            <label class="form-label text-muted small">PRECIO/NOCHE</label>
            <div class="h2 fw-bold text-primary">${{ hotelService.selectedRoom()?.price_night | number:'1.2-2' }}</div>
          </div>
        </div>

        @if (hotelService.selectedRoom()?.status === 'occupied' && activeBooking) {
        <div class="card bg-light border-0 mb-3">
          <div class="card-body p-3">
            <div class="small text-muted mb-1">HU√âSPED ACTUAL</div>
            <div class="fw-bold h4 mb-0 text-dark">
              {{ activeBooking.guest_name || 'Cargando datos...' }}
            </div>
            <div class="text-muted small">
              Check-out: {{ activeBooking.check_out | date:'dd/MM/yyyy' }}
            </div>
            <div class="mt-2">
              <span class="badge" [class.bg-success]="activeBooking.payment_status === 'paid'"
                [class.bg-warning]="activeBooking.payment_status !== 'paid'">
                PAGO: {{ activeBooking.payment_status | uppercase }}
              </span>
            </div>
          </div>
        </div>
        }

        <div class="hr-text my-4">ACCIONES OPERATIVAS</div>

        <div class="d-grid gap-2">
          @if (hotelService.selectedRoom()?.status === 'available') {
          <button
            class="btn btn-outline-primary btn-lg d-flex align-items-center justify-content-between px-4 shadow-sm"
            (click)="viewMode.set('checkin')">
            <div class="text-start">
              <div class="fw-bold">Registrar Check-in</div>
              <div class="small opacity-75">Asignar nuevo hu√©sped</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-login" width="24" height="24"
              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
              <path d="M20 12h-13l3 -3m0 6l-3 -3" />
            </svg>
          </button>
          } @else if (hotelService.selectedRoom()?.status === 'occupied') {

          @if (activeBooking?.payment_status !== 'paid') {
          <button
            class="btn btn-success btn-lg d-flex align-items-center justify-content-between px-4 shadow-sm border-0 mb-2"
            (click)="markAsPaid(activeBooking)">
            <div class="text-start">
              <div class="fw-bold">üí∞ Registrar Pago</div>
              <div class="small opacity-75">Monto: ${{ activeBooking?.total_amount | number:'1.2-2' }}</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cash" width="24" height="24"
              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path d="M7 9m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z" />
              <path d="M14 12a2 2 0 1 0 0 4a2 2 0 0 0 0 -4" />
              <path d="M7 15v.01" />
              <path d="M2 8v8a2 2 0 0 0 2 2h2" />
              <path d="M17 9v-2a2 2 0 0 0 -2 -2h-10a2 2 0 0 0 -2 2v6a2 2 0 0 0 2 2h2" />
            </svg>
          </button>
          }

          <button class="btn btn-outline-danger btn-lg d-flex align-items-center justify-content-between px-4 shadow-sm"
            (click)="handleCheckout()">
            <div class="text-start">
              <div class="fw-bold">Realizar Check-out</div>
              <div class="small opacity-75">Finalizar estancia</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-logout" width="24" height="24"
              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
              <path d="M9 12h12l-3 -3m0 6l3 -3" />
            </svg>
          </button>
          }
        </div>

        <div class="text-center mt-4">
          <button class="btn btn-link text-warning btn-sm fw-medium" (click)="notifyN8N('maintenance')">
            üõ† Reportar Falla / Mantenimiento
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
}

@if (showReportModal) {
<div class="modal-backdrop fade show"></div>
<div class="modal modal-blur fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title">üìà Reporte de Ventas</h5>
        <div class="ms-auto d-flex gap-1 me-2">
          <button class="btn btn-outline-primary btn-sm" [class.active]="reportFilter() === 'day'"
            (click)="reportFilter.set('day'); generateDailyReport()">D√≠a</button>
          <button class="btn btn-outline-primary btn-sm" [class.active]="reportFilter() === 'week'"
            (click)="reportFilter.set('week'); generateDailyReport()">Semana</button>
          <button class="btn btn-outline-primary btn-sm" [class.active]="reportFilter() === 'month'"
            (click)="reportFilter.set('month'); generateDailyReport()">Mes</button>
          <button class="btn btn-outline-primary btn-sm" [class.active]="reportFilter() === 'year'"
            (click)="reportFilter.set('year'); generateDailyReport()">A√±o</button>
        </div>
        <button type="button" class="btn-close" (click)="showReportModal = false"></button>
      </div>
      <div class="modal-body p-4 bg-light text-dark">
        <div class="row row-cards mb-3">
          <div class="col-4">
            <div class="card card-sm bg-blue-lt p-3 text-center">
              <div class="text-muted small">VENTAS TOTALES</div>
              <div class="h2 fw-bold text-primary">${{ dailyReport.total | number:'1.2-2' }}</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card card-sm bg-green-lt p-3 text-center">
              <div class="text-muted small">COBRADO (EFECTIVO)</div>
              <div class="h2 fw-bold text-success">${{ dailyReport.paid | number:'1.2-2' }}</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card card-sm bg-orange-lt p-3 text-center">
              <div class="text-muted small">POR COBRAR</div>
              <div class="h2 fw-bold text-warning">${{ dailyReport.pending | number:'1.2-2' }}</div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-header bg-white py-2">
            <h4 class="card-title">DETALLE DE MOVIMIENTOS - {{ dailyReport.periodLabel }}</h4>
          </div>
          <div class="table-responsive" style="max-height: 300px;">
            <table class="table table-vcenter card-table">
              <thead>
                <tr>
                  <th>HORA</th>
                  <th>HABITACI&Oacute;N</th>
                  <th>ESTANCIA</th>
                  <th>ESTADO</th>
                  <th>MONTO</th>
                </tr>
              </thead>
              <tbody>
                @for (t of dailyReport.transactions; track t.id) {
                <tr>
                  <td>{{ t.created_at | date:'HH:mm' }}</td>
                  <td class="fw-bold">Hab. {{ getRoomNumber(t.room_id) }}</td>
                  <td>{{ getNights(t.check_in, t.check_out) }} noches</td>
                  <td><span class="badge" [class.bg-success]="t.payment_status === 'paid'"
                      [class.bg-warning]="t.payment_status !== 'paid'">{{ t.payment_status }}</span></td>
                  <td class="fw-bold text-primary">${{ t.total_amount | number:'1.2-2' }}</td>
                </tr>
                } @empty {
                <tr>
                  <td colspan="5" class="text-center py-4">üì¨<br>No se encontraron transacciones en este periodo.</td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-white">
        <button class="btn btn-link text-muted" (click)="showReportModal = false">Cerrar</button>
        <button class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
            <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" />
            <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" />
            <path d="M7 13m0 2a2 2 0 0 1 2 -2h6a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-6a2 2 0 0 1 -2 -2z" />
          </svg> Imprimir Reporte</button>
      </div>
    </div>
  </div>
</div>
}

@if (isUserModalOpen()) {
<div class="modal-backdrop fade show"></div>
<div class="modal modal-blur fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">{{ hotelService.selectedUser() ? 'Editar' : 'Nuevo' }} Empleado</h5>
        <button type="button" class="btn-close btn-close-white" (click)="isUserModalOpen.set(false)"></button>
      </div>
      <div class="modal-body p-4 bg-light text-dark">
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">Nombres</label>
            <input type="text" class="form-control shadow-sm" [(ngModel)]="tempUser.names">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">Apellidos</label>
            <input type="text" class="form-control shadow-sm" [(ngModel)]="tempUser.lastname">
          </div>
        </div>
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">Tel√©fono</label>
            <input type="tel" class="form-control shadow-sm" [(ngModel)]="tempUser.phone" placeholder="9991234567">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label fw-bold">Rol</label>
            <select class="form-select shadow-sm" [(ngModel)]="tempUser.role">
              <option value="ADMIN">Administrador</option>
              <option value="EDITOR">Recepcionista</option>
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Correo Electr√≥nico</label>
          <input type="email" class="form-control shadow-sm" [(ngModel)]="tempUser.email"
            [disabled]="hotelService.selectedUser() !== null">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Contrase√±a</label>
          <input type="password" class="form-control shadow-sm" [(ngModel)]="tempUser.password"
            placeholder="Dejar vac√≠o para no cambiar">
        </div>
      </div>
      <div class="modal-footer bg-white">
        <button class="btn btn-link text-muted" (click)="isUserModalOpen.set(false)">Cancelar</button>
        <button class="btn btn-primary px-4 shadow-sm" (click)="handleSaveUser()">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>
}
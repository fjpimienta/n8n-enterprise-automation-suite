<div class="page-header d-print-none text-white bg-dark py-3">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle text-muted-light">Dashboard</div>
        <h2 class="page-title text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-building-skyscraper" width="24"
            height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M3 21l18 0" />
            <path d="M5 21v-14l8 -4l8 4v14" />
            <path d="M19 21v-10l-6 -4" />
            <path d="M9 9l0 .01" />
            <path d="M9 12l0 .01" />
            <path d="M9 15l0 .01" />
            <path d="M9 18l0 .01" />
          </svg>
          Hotel San Jos&eacute;
        </h2>
      </div>
      <div class="col-auto ms-auto d-flex gap-2">
        <button class="btn btn-icon btn-dark" (click)="refresh()" title="Refrescar">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
          </svg>
        </button>
        <button (click)="generateDailyReport()" class="btn btn-primary btn-sm me-2">
          üí∞ Caja
        </button>
        <button (click)="logout()" class="btn btn-danger btn-sm">Salir</button>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">

    <div class="mb-4">
      <div class="d-flex flex-wrap gap-2 justify-content-center mb-2 px-2">
        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-primary]="hotelService.filter() === 'all'"
          (click)="hotelService.filter.set('all')">Todas</button>

        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-success]="hotelService.filter() === 'available'"
          (click)="hotelService.filter.set('available')">‚úÖ Disponibles</button>

        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-danger]="hotelService.filter() === 'occupied'"
          (click)="hotelService.filter.set('occupied')">üè® Ocupadas</button>

        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-warning]="hotelService.filter() === 'checkout'"
          (click)="hotelService.filter.set('checkout')">üßπ Check-out</button>

        <button class="btn btn-pill btn-sm text-nowrap" [class.btn-secondary]="hotelService.filter() === 'maintenance'"
          (click)="hotelService.filter.set('maintenance')">üõ†Ô∏è Mantenimiento</button>
      </div>

      @if (isAdmin && viewMode() !== 'user_mgmt') {
      <div class="d-flex justify-content-center px-2">
        <button (click)="openUserManagement()" class="btn btn-sm btn-outline-info shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users me-1" width="24" height="24"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
            <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
          </svg>
          Gestionar Personal
        </button>
      </div>
      }
    </div>

    @if (viewMode() === 'user_mgmt') {
    <div class="d-flex mb-3 align-items-center">
      <button (click)="viewMode.set('details')" class="btn btn-sm btn-ghost-secondary me-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-back-up" width="24"
          height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
          <path d="M9 14l-4 -4l4 -4" />
          <path d="M5 10h11a4 4 0 1 1 0 8h-1" />
        </svg>
        Volver
      </button>
      <h2 class="text-white mb-0">Gesti√≥n de Personal</h2>
      <button class="btn btn-primary btn-sm ms-auto" (click)="openNewUserModal()">+ Nuevo Empleado</button>
    </div>

    <div class="row row-cards">
      @for (user of hotelService.users(); track user.email) {
      <div class="col-12 col-md-6">
        <div class="card shadow-sm border-0 mb-2">
          <div class="card-body d-flex align-items-center p-3 text-dark bg-white rounded shadow-sm">
            <span class="avatar avatar-sm me-3 bg-blue-lt text-uppercase fw-bold">
              {{ (user.names || '?').charAt(0) }}{{ (user.lastname || '').charAt(0) }}
            </span>
            <div class="flex-fill">
              <div class="fw-bold">{{ user.names }} {{ user.lastname }}</div>
              <div class="text-muted small">{{ user.role }} ‚Ä¢ {{ user.email }}</div>
            </div>
            <button class="btn btn-icon btn-ghost-primary" (click)="editUser(user)">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
                <path d="M13.5 6.5l4 4" />
              </svg>
            </button>
          </div>
        </div>
      </div>
      } @empty {
      <div class="text-center py-5 text-muted">
        <p>No hay empleados registrados.</p>
      </div>
      }
    </div>
    }

    @else {
    <div class="row row-cards g-2">
      @for (room of hotelService.filteredRooms(); track room.id) {
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card card-sm shadow-sm border-0 h-100"
          [style.border-left]="isArrivalToday(room.next_reservation) ? '5px solid #206bc4' : 'none'"
          style="cursor: pointer;" (click)="onSelectRoom(room)">
          <div class="card-body p-3 bg-white rounded">
            <div class="d-flex align-items-center">
              <div class="h1 mb-0 me-3 fw-bold text-primary">{{ room.room_number }}</div>
              <div class="flex-fill text-dark">
                <div class="font-weight-medium h4 mb-0 text-capitalize">{{ room.type }}</div>
                <div class="text-muted small mt-1">
                  @if (room.next_reservation) {
                  <span class="text-azure fw-bold">üìÖ {{ room.next_reservation | date:'dd/MM' }}</span>
                  }
                </div>
              </div>
              <div class="text-end">
                <span class="badge" [class.bg-red-lt]="room.status === 'occupied'"
                  [class.bg-green-lt]="room.status === 'available'" [class.bg-dark-lt]="room.status === 'maintenance'">
                  {{ room.status | uppercase }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      } @empty {
      <div class="col-12 text-center py-5">
        <p class="text-muted">No hay habitaciones con este filtro.</p>
      </div>
      }
    </div>
    }

  </div>
</div>

@if (isUserModalOpen()) {
<div class="modal-backdrop fade show"></div>
<div class="modal modal-blur fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title">{{ hotelService.selectedUser() ? 'Editar' : 'Nuevo' }} Empleado</h5>
        <button type="button" class="btn-close" (click)="isUserModalOpen.set(false)"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label text-dark">Nombres</label>
            <input type="text" class="form-control" [(ngModel)]="tempUser.names">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label text-dark">Apellidos</label> <input type="text" class="form-control"
              [(ngModel)]="tempUser.lastname">
          </div>
        </div>

        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label text-dark">Tel√©fono</label> <input type="tel" class="form-control"
              [(ngModel)]="tempUser.phone" placeholder="Ej: 9991234567">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label text-dark">Rol</label>
            <select class="form-select" [(ngModel)]="tempUser.role">
              <option value="ADMIN">Administrador</option>
              <option value="EDITOR">Recepcionista</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-dark">Correo Electr√≥nico</label>
          <input type="email" class="form-control" [(ngModel)]="tempUser.email"
            [disabled]="hotelService.selectedUser() !== null">
        </div>

        <div class="mb-3">
          <label class="form-label text-dark">Contrase√±a</label>
          <input type="password" class="form-control" [(ngModel)]="tempUser.password"
            placeholder="M√≠n. 6 caract. (Dejar vac√≠o para no cambiar)">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-link" (click)="isUserModalOpen.set(false)">Cancelar</button>
        <button class="btn btn-primary" (click)="handleSaveUser()">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>
}
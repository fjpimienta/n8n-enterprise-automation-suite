<app-header (onRefresh)="refresh()" (onRefreshMain)="refreshMain()" (onGenerateReport)="generateDailyReport()"
  (onLogout)="logout()">
</app-header>

<div class="page-body">
  <div class="container-xl">

    @if (viewMode() === 'details' || viewMode() === 'checkin' || viewMode() === 'checkout_validation') {
    <app-room-filters [currentFilter]="bookingService.filter()" [isAdmin]="isAdmin"
      (onFilterChange)="bookingService.filter.set($event)" (onManageGuests)="openGuestManagement()"
      (onManageUsers)="openUserManagement()" (onReservations)="openReservations()">
    </app-room-filters>

    <div class="row row-cards g-2">
      @if (bookingService.loadingRooms()) {
      @for (i of [1,2,3,4,5,6,7,8]; track i) {
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <app-skeleton></app-skeleton>
      </div>
      }
      } @else {
      @for (room of bookingService.filteredRooms(); track room.id) {
      <div class="col-sm-6 col-lg-3">
        <app-room-card [room]="room" (onSelect)="onSelectRoom($event)"></app-room-card>
      </div>
      } @empty {
      <div class="col-12">
        <div class="card card-stacked py-5 border-0 shadow-none bg-transparent">
          <div class="card-body text-center">
            <div class="display-1 text-muted-lt mb-3"><i class="ti ti-ghost"></i></div>
            <p class="h2">No hay habitaciones</p>
            <p class="text-muted">
              Actualmente no hay habitaciones en estado:
              <span class="badge bg-primary-lt">{{ bookingService.translatedFilter() | uppercase }}</span>
            </p>
          </div>
        </div>
      </div>
      }
      }
    </div>
    }

    @if (viewMode() === 'checkin') {
    <app-checkin-form [room]="hotelService.selectedRoom()" [reservation]="activeBooking"
      (onClose)="viewMode.set('details')" (saved)="handleCheckinSave($event)">
    </app-checkin-form>
    }

    @if (viewMode() === 'checkout_validation') {
    <app-checkout-form [room]="hotelService.selectedRoom()" [reservation]="activeBooking" (saved)="onCheckoutSuccess()"
      (canceled)="onCheckoutCancel()">
    </app-checkout-form>
    }

    @if (viewMode() === 'reservation') {
    <app-reservation-manager (onClose)="viewMode.set('details')" (onSaved)="refresh()">
    </app-reservation-manager>
    }

    @if (viewMode() === 'guest_mgmt') {
    @if (adminService.loadingGuests()) {
    <div class="card">
      <div class="table-responsive">
        <table class="table table-vcenter card-table">
          <tbody>
            @for (i of [1,2,3,4,5]; track i) {
            <tr>
              <td><app-skeleton appearance="line"></app-skeleton></td>
              <td><app-skeleton appearance="line" style="width: 50px;"></app-skeleton></td>
              <td><app-skeleton appearance="line" style="width: 80px;"></app-skeleton></td>
              <td class="w-1"><app-skeleton appearance="circle"></app-skeleton></td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    } @else {
    <app-guest-list [guests]="adminService.guests()" (onBack)="viewMode.set('details')" (onAdd)="openNewGuestModal()"
      (onEdit)="editGuest($event)">
    </app-guest-list>
    }
    }

    @if (viewMode() === 'user_mgmt') {
    @if (adminService.loadingUsers()) {
    <div class="card">
      <div class="table-responsive">
        <table class="table table-vcenter card-table">
          <tbody>
            @for (i of [1,2,3,4,5]; track i) {
            <tr>
              <td><app-skeleton appearance="line"></app-skeleton></td>
              <td><app-skeleton appearance="line" style="width: 50px;"></app-skeleton></td>
              <td><app-skeleton appearance="line" style="width: 80px;"></app-skeleton></td>
              <td class="w-1"><app-skeleton appearance="circle"></app-skeleton></td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    } @else {
    <app-user-list [users]="adminService.users()" (onBack)="viewMode.set('details')" (onAdd)="openNewUserModal()"
      (onEdit)="editUser($event)">
    </app-user-list>
    }
    }
  </div>
</div>

@if (hotelService.selectedRoom() && viewMode() === 'details') {
<app-room-detail-modal [room]="hotelService.selectedRoom()" [activeBooking]="activeBooking"
  (onClose)="hotelService.clearSelection()" (onCheckin)="viewMode.set('checkin')" (onMarkAsClean)="markRoomAsClean()"
  (onReservations)="viewMode.set('reservation')" (onCheckout)="startCheckoutProcess()" (onPay)="markAsPaid($event)"
  (onMaintenance)="reportMaintenance()" (onFinishMaintenance)="handleFinishMaintenance()">
</app-room-detail-modal>
}

<app-user-form-modal [isOpen]="isUserModalOpen()" [selectedUser]="hotelService.selectedUser()" [(userData)]="tempUser"
  (onClose)="isUserModalOpen.set(false)" (onSave)="handleSaveUser()">
</app-user-form-modal>

<app-guest-form-modal [isOpen]="isGuestModalOpen()" [selectedGuest]="hotelService.selectedGuest()"
  [(guestData)]="tempGuest" (onClose)="isGuestModalOpen.set(false)" (onSave)="handleSaveGuest()">
</app-guest-form-modal>

<app-daily-report-modal [isOpen]="showReportModal" [isLoading]="reportService.loadingReports()"
  [reportData]="dailyReport" [currentFilter]="reportFilter()" [roomsList]="bookingService.rooms()"
  (onClose)="showReportModal = false" (onFilterChange)="handleReportFilterChange($event)">
</app-daily-report-modal>
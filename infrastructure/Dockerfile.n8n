# Fase 1: Instalamos todo en un Debian normal
FROM debian:bookworm-slim AS builder

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    curl \
    git \
    make \
    g++ \
    build-essential \
    postgresql-client \
    && apt-get clean

# Fase 2: Imagen de n8n final
FROM docker.n8n.io/n8nio/n8n:latest

USER root

# Copiamos los binarios y librerías desde el builder
COPY --from=builder /usr/bin/python3* /usr/bin/
COPY --from=builder /usr/lib/python3* /usr/lib/
COPY --from=builder /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu
COPY --from=builder /usr/bin/git* /usr/bin/
COPY --from=builder /usr/bin/curl /usr/bin/
COPY --from=builder /usr/bin/make /usr/bin/
COPY --from=builder /usr/bin/psql /usr/bin/

# Instalamos las librerías de Node
RUN npm install -g jsonwebtoken pdf-parse && \
    mkdir -p /home/node/.n8n/custom && \
    npm install --prefix /home/node/.n8n/custom @n8n/n8n-nodes-langchain@latest && \
    npm cache clean --force

# Fix para el Blob
RUN echo "globalThis.Blob = require('buffer').Blob;" > /home/node/.n8n/custom/init-blob.js

USER node

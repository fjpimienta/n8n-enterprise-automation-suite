{
  "name": "Normalize v2",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -432,
        -112
      ],
      "id": "17e2dafe-7ffc-475b-82f0-11a743f337ba",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsCode": "// Recuperamos datos del input\nconst sqlResults = $json.sql_results || []; \nconst operation = $json.operation || 'unknown';\nconst modelConfig = $item(0, 0).$node[\"Prepare Normalize\"].json.model_config; // Acceso a la config original\nconst modelHooks = modelConfig.hooks || { pre: [], post: [] };\n\nconst rows = Array.isArray(sqlResults) \n  ? sqlResults.filter(row => row && typeof row === 'object' && Object.keys(row).length > 0 && !row.hasOwnProperty('success'))\n  : [];\n\nlet data = rows;\nlet resultStatus = \"success\";\nlet message = undefined;\nlet foundRecords = rows.length;\n\n// Lógica de validación por operación\nswitch (operation.toLowerCase()) {\n  case 'getone':\n    if (rows.length === 0) {\n      data = null;\n      resultStatus = \"error\";\n      message = \"Registro no encontrado.\";\n      foundRecords = 0;\n    } else {\n      data = rows[0];\n      foundRecords = 1;\n    }\n    break;\n\n  case 'update':\n    if (rows.length === 0) {\n      data = [];\n      resultStatus = \"error\";\n      message = \"No se actualizó ningún registro. Verifica que el ID sea correcto.\";\n      foundRecords = 0;\n    }\n    break;\n\n  case 'delete':\n    if (rows.length === 0) {\n      data = [];\n      resultStatus = \"error\";\n      message = \"No se pudo eliminar. El registro no existe.\";\n      foundRecords = 0;\n    } else {\n      message = \"Registro eliminado con éxito.\";\n    }\n    break;\n\n  case 'getall':\n    data = rows;\n    foundRecords = rows.length;\n    break;\n\n  case 'insert':\n    data = rows[0] || rows;\n    foundRecords = rows.length;\n    break;\n}\n\n// Solo ejecutamos hooks post-execution si la operación principal fue exitosa\nlet postHooks = [];\nif (resultStatus === \"success\" && modelHooks.post && modelHooks.post.length > 0) {\n    postHooks = modelHooks.post; \n}\n\nreturn [{\n  json: {\n    error: resultStatus !== \"success\",\n    operation,\n    data,\n    meta: {\n      foundRecords,\n      model: modelConfig.model_name,\n      timestamp: new Date().toISOString()\n    }\n  }\n}];\n\n\n/*\nreturn [{\n  json: {\n    operation,\n    result: resultStatus,\n    data: (operation === 'getone' || operation === 'insert') ? (rows[0] || rows) : rows,\n    execution_info: {\n        timestamp: new Date().toISOString(),\n        model: modelConfig.model_name,\n        has_post_hooks: postHooks.length > 0,\n        hooks_to_execute: postHooks\n    }\n  }\n}];\n*/"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -256,
        -112
      ],
      "id": "754a8d2b-415c-46d2-bb65-37fa64342b5f",
      "name": "Normalize"
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Normalize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "9SrVXdATmlrZemJT"
  },
  "versionId": "180895ee-b1db-416c-b6c7-7d76a7883b06",
  "meta": {
    "instanceId": "2ebfe6551ca260f617d68572b7a0eb6825fe3993d0da19ebfb0e274f2e0ccb37"
  },
  "id": "iFawDMkvCwPbg4bn",
  "tags": []
}
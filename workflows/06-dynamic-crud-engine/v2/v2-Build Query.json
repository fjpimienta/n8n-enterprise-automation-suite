{
  "name": "v2/Build Query",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Usar $input en subworkflows\nconst input = $input.first().json;\n\n// Desestructuración defensiva\nconst config = input.model_config || {};\nconst bodyRaw = input.body || {};\n\n// Detectar si el body es un array (para bulk) o un objeto con metadatos\nconst isBulk = Array.isArray(bodyRaw) || (bodyRaw.data && Array.isArray(bodyRaw.data));\nconst dataPayload = isBulk ? (Array.isArray(bodyRaw) ? bodyRaw : bodyRaw.data) : bodyRaw;\n\n// Metadatos para paginación y filtros\nconst meta = isBulk ? bodyRaw : dataPayload; \n\nconst operation = (input.operation || meta.operation || 'getall').toLowerCase();\nconst table = config.table_name;\n\nif (!table) throw new Error(`Modelo sin table_name configurado`);\n\n// --- CONFIGURACIÓN DE JOINS (Mantenida intacta) ---\nconst joins = config.joins || [];\nconst buildJoins = () => {\n    if (!joins.length) return '';\n    return joins.map(j => \n        ` LEFT JOIN ${j.table} ON ${table}.${j.own_col} = ${j.table}.${j.foreign_col}`\n    ).join(' ');\n};\n\nconst buildSelectFields = () => {\n    if (!joins.length) return `${table}.*`;\n    let select = `${table}.*`;\n    joins.forEach(j => {\n        select += `, row_to_json(${j.table}.*) as ${j.table}_data`;\n    });\n    return select;\n};\n\nlet query = '';\nlet values = [];\n\n// --- LÓGICA CORE ---\nswitch (operation) {\n  case 'insert':\n  case 'bulkinsert': {\n    if (isBulk && dataPayload.length > 0) {\n        // LÓGICA BULK INSERT (Mantenida intacta)\n        const cols = Object.keys(dataPayload[0]);\n        let paramIndex = 1;\n        const rowPlaceholders = [];\n        values = [];\n        dataPayload.forEach(row => {\n            const rowParams = [];\n            cols.forEach(col => {\n                rowParams.push(`$${paramIndex++}`);\n                values.push(row[col]);\n            });\n            rowPlaceholders.push(`(${rowParams.join(', ')})`);\n        });\n        query = `INSERT INTO ${table} (${cols.join(', ')}) VALUES ${rowPlaceholders.join(', ')} RETURNING *;`;\n    } else {\n        // INSERT SIMPLE\n        const fields = dataPayload.fields || dataPayload;\n        const cols = Object.keys(fields);\n        query = `INSERT INTO ${table} (${cols.join(', ')}) VALUES (${cols.map((_, i) => `$${i + 1}`).join(', ')}) RETURNING *;`;\n        values = Object.values(fields);\n    }\n    break;\n  }\n\n  case 'update': {\n    const fields = dataPayload.fields || {};\n    const pkField = config.primary_key || 'id';\n    const pkValue = fields[pkField] || meta.id || meta.filter_value;\n    const updateFields = { ...fields };\n    delete updateFields[pkField];\n    const cols = Object.keys(updateFields);\n    if (cols.length === 0) throw new Error('No hay campos para actualizar');\n    const setClause = cols.map((c, i) => `${c} = $${i + 1}`).join(', ');\n    values = Object.values(updateFields);\n    values.push(pkValue); \n    query = `UPDATE ${table} SET ${setClause} WHERE ${pkField} = $${values.length} RETURNING *;`;\n    break;\n  }\n\n  case 'delete': {\n    const pkField = config.primary_key || 'id';\n    const pkValue = dataPayload[pkField] || meta.id || meta.filter_value;\n    if (!pkValue) throw new Error(`Falta el valor de ${pkField} para eliminar`);\n    query = `DELETE FROM ${table} WHERE ${pkField} = $1 RETURNING *;`;\n    values = [pkValue];\n    break;\n  }\n    \n  case 'getone': {\n    const pkField = config.primary_key || 'id';\n    const val = meta[pkField] || meta.filter_value || meta.id;\n    if (!val) throw new Error(`Falta identificador para getOne`);\n    query = `SELECT ${buildSelectFields()} FROM ${table} ${buildJoins()} WHERE ${table}.${pkField} = $1;`;\n    values = [val];\n    break;\n  }\n\n  case 'getall': {\n    const select = buildSelectFields();\n    const joinSql = buildJoins();\n    const limit = meta.limit ? parseInt(meta.limit) : 100;\n    const offset = meta.offset ? parseInt(meta.offset) : 0;\n    \n    let baseQuery = `SELECT ${select} FROM ${table} ${joinSql}`;\n    const allowedFields = config.allowed_fields || [];\n    const filterFields = meta.fields || {};\n    \n    let whereParts = [];\n    let paramIndex = 1;\n    values = [];\n\n    // --- FILTROS DINÁMICOS CON OPERADORES (Corregido) ---\n    Object.entries(filterFields).forEach(([key, value]) => {\n        if (allowedFields.includes(key)) {\n            if (value !== null && typeof value === 'object' && !Array.isArray(value)) {\n                Object.entries(value).forEach(([op, val]) => {\n                    const sqlOp = op === '_gte' ? '>=' : op === '_lte' ? '<=' : op === '_gt' ? '>' : op === '_lt' ? '<' : '=';\n                    whereParts.push(`${table}.${key} ${sqlOp} $${paramIndex++}`);\n                    values.push(val);\n                });\n            } else {\n                whereParts.push(`${table}.${key} = $${paramIndex++}`);\n                values.push(value);\n            }\n        }\n    });\n\n    if (whereParts.length > 0) {\n        baseQuery += ` WHERE ${whereParts.join(' AND ')}`;\n    }\n\n    query = `${baseQuery} LIMIT $${paramIndex++} OFFSET $${paramIndex++};`;\n    values.push(limit, offset);\n    break;\n  }\n\n  default:\n    return [{ json: { error: true, status: 400, message: `Operación no soportada: ${operation}` } }];\n}\n\nreturn [{\n  json: {\n    query,\n    values,\n    operation,\n    transactional: isBulk || operation === 'delete'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        256,
        -176
      ],
      "id": "c6ff55ec-01ed-486c-8e32-0f0c2cc1c5f5",
      "name": "Build Query"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        32,
        -176
      ],
      "id": "f94cd53a-539a-452f-a5e5-b1eb5ed81bff",
      "name": "When Executed by Another Workflow"
    }
  ],
  "pinData": {},
  "connections": {
    "Build Query": {
      "main": [
        []
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Build Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "9SrVXdATmlrZemJT"
  },
  "versionId": "6d9483f3-6aa8-4232-8987-32354141ae68",
  "meta": {
    "instanceId": "2ebfe6551ca260f617d68572b7a0eb6825fe3993d0da19ebfb0e274f2e0ccb37"
  },
  "id": "NO6LIndnkfNuxK5N",
  "tags": []
}
{
  "name": "v2/Build Query",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// 1. Captura de entrada\nconst input = $input.first().json;\nconst config = input.model_config || {};\n\n// 2. Prioridad de Operación\nlet operation = (input.operation || (input.body && input.body.operation) || 'getall').toLowerCase().trim();\n\n// 3. Extraer los datos\nconst body = input.body || {};\nconst fields = body.fields || {}; \n\nconst table = config.table_name;\nif (!table) throw new Error(`Modelo sin table_name configurado`);\n\nconst joins = config.joins || [];\nconst buildJoins = () => {\n    if (!joins.length) return '';\n    return joins.map(j => ` LEFT JOIN ${j.table} ON ${table}.${j.own_col} = ${j.table}.${j.foreign_col}`).join(' ');\n};\n\nconst buildSelectFields = () => {\n    if (!joins.length) return `${table}.*`;\n    let select = `${table}.*`;\n    joins.forEach(j => { select += `, row_to_json(${j.table}.*) as ${j.table}_data`; });\n    return select;\n};\n\nlet query = '';\nlet values = [];\n\nswitch (operation) {\n    case 'getall':\n    case 'select': {\n        const limit = body.limit || 100;\n        const offset = body.offset || 0;\n        const allowedFields = config.allowed_fields || [];\n        \n        let baseQuery = `SELECT ${buildSelectFields()} FROM ${table} ${buildJoins()}`;\n        let whereParts = [];\n        let paramIndex = 1;\n        values = [];\n\n        Object.entries(fields).forEach(([key, value]) => {\n            if (allowedFields.includes(key)) {\n                if (value !== null && typeof value === 'object' && !Array.isArray(value)) {\n                    Object.entries(value).forEach(([op, val]) => {\n                        const sqlOp = op === '_gte' ? '>=' : op === '_lte' ? '<=' : op === '_gt' ? '>' : op === '_lt' ? '<' : '=';\n                        whereParts.push(`${table}.${key} ${sqlOp} $${paramIndex++}`);\n                        values.push(val);\n                    });\n                } else {\n                    whereParts.push(`${table}.${key} = $${paramIndex++}`);\n                    values.push(value);\n                }\n            }\n        });\n\n        if (whereParts.length > 0) baseQuery += ` WHERE ${whereParts.join(' AND ')}`;\n        query = `${baseQuery} LIMIT $${paramIndex++} OFFSET $${paramIndex++};`;\n        values.push(limit, offset);\n        break;\n    }\n\n    case 'getone': {\n        const pkField = config.primary_key || 'id';\n        \n        // --- CAMBIO AQUÍ: Lógica Inteligente ---\n        // 1. Intentamos buscar por la Primary Key primero\n        let searchField = pkField;\n        let val = fields[pkField] || body[pkField] || body.id || body.filter_value;\n\n        // 2. Si no hay PK, buscamos el primer campo disponible en 'fields'\n        if (!val && Object.keys(fields).length > 0) {\n            searchField = Object.keys(fields)[0];\n            val = fields[searchField];\n        }\n        \n        if (!val) throw new Error(`Operación GETONE requiere al menos un campo en 'fields' o un ID.`);\n        \n        query = `SELECT ${buildSelectFields()} FROM ${table} ${buildJoins()} WHERE ${table}.${searchField} = $1 LIMIT 1;`;\n        values = [val];\n        break;\n    }\n\n    default:\n        query = `SELECT * FROM ${table} LIMIT 10;`;\n}\n\nreturn [{\n    json: {\n        query,\n        values,\n        operation,\n        is_transactional: ['insert', 'update', 'delete'].includes(operation)\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        256,
        -176
      ],
      "id": "c6ff55ec-01ed-486c-8e32-0f0c2cc1c5f5",
      "name": "Build Query"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        32,
        -176
      ],
      "id": "f94cd53a-539a-452f-a5e5-b1eb5ed81bff",
      "name": "When Executed by Another Workflow"
    }
  ],
  "pinData": {},
  "connections": {
    "Build Query": {
      "main": [
        []
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Build Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "9SrVXdATmlrZemJT"
  },
  "versionId": "332dac7e-6add-4221-946b-d51aff5277fc",
  "meta": {
    "instanceId": "2ebfe6551ca260f617d68572b7a0eb6825fe3993d0da19ebfb0e274f2e0ccb37"
  },
  "id": "NO6LIndnkfNuxK5N",
  "tags": []
}